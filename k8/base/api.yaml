apiVersion: v1
kind: Service
metadata:
  name: api
  labels:
    app: api
spec:
  selector:
    app: api-v1
  ports:
    - port: 8080
      name: api
    - port: 9090
      name: metrics
  type: ClusterIP
---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: api
  labels:
    app: api
spec:
  endpoints:
    - port: metrics
  selector:
    matchLabels:
      app: api
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: api-01
  labels:
    app: api
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: api-v1
  template:
    metadata:
      labels:
        app: api-v1
    spec:
      containers:
        - name: api
          image: tableland/api
          imagePullPolicy: Always
          ports:
            - name: api
              containerPort: 8080
            - name: metrics
              containerPort: 9090
          command: ["./api"]
          env:
            - name: DB_PASS
              valueFrom:
                secretKeyRef:
                  name: tableland-secret
                  key: postgres-password
            - name: DB_USER
              valueFrom:
                secretKeyRef:
                  name: tableland-secret
                  key: postgres-user
            - name: VALIDATOR_ALCHEMY_OPTIMISM_KOVAN_API_KEY
              valueFrom:
                secretKeyRef:
                  name: tableland-secret
                  key: validator-alchemy-optimism-kovan-api-key
            - name: VALIDATOR_ALCHEMY_ETHEREUM_GOERLI_API_KEY
              valueFrom:
                secretKeyRef:
                  name: tableland-secret
                  key: validator-alchemy-ethereum-goerli-api-key
            - name: VALIDATOR_ALCHEMY_POLYGON_MUMBAI_API_KEY
              valueFrom:
                secretKeyRef:
                  name: tableland-secret
                  key: validator-alchemy-polygon-mumbai-api-key
            - name: VALIDATOR_OPTIMISM_KOVAN_SIGNER_PRIVATE_KEY
              valueFrom:
                secretKeyRef:
                  name: tableland-secret
                  key: validator-optimism-kovan-signer-private-key
            - name: VALIDATOR_ETHEREUM_GOERLI_SIGNER_PRIVATE_KEY
              valueFrom:
                secretKeyRef:
                  name: tableland-secret
                  key: validator-ethereum-goerli-signer-private-key
            - name: VALIDATOR_POLYGON_MUMBAI_SIGNER_PRIVATE_KEY
              valueFrom:
                secretKeyRef:
                  name: tableland-secret
                  key: validator-polygon-mumbai-signer-private-key
          envFrom:
            - configMapRef:
                name: configmap-api
          resources:
            requests:
              cpu: 250m
              memory: 512Mi
          readinessProbe:
            httpGet:
              path: /healthz
              port: api
            initialDelaySeconds: 5
            periodSeconds: 10
            failureThreshold: 3
          livenessProbe:
            httpGet:
              path: /healthz
              port: api
            initialDelaySeconds: 15
            periodSeconds: 20
            failureThreshold: 3
          volumeMounts:
            - name: validator-config
              mountPath: /app/config.json
              subPath: config.json
      volumes:
        - name: validator-config
          configMap:
            name: configmap-validator-config
            items:
              - key: config-validator.json
                path: config.json
